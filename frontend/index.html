<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NARU Centralized Dashboard — Demo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    #map { height: 70vh; }
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,.6); display: none; align-items: center; justify-content: center; }
    .card { background: #0f172a; color: #e2e8f0; border: 1px solid #1f2937; border-radius: 14px; }
  </style>
</head>
<body class="bg-slate-900 text-slate-100">
  <header class="p-4 flex items-center justify-between">
    <h1 class="text-xl font-bold">NARU Centralized Dashboard — Demo</h1>
    <div class="text-sm opacity-80">Mode: DEMO (mock) · Optional LIVE (Directions)</div>
  </header>

  <main class="p-4 grid gap-4 lg:grid-cols-3">
    <section class="lg:col-span-2 card p-3">
      <div id="map"></div>
      <div class="mt-3 flex gap-2">
        <button id="btnLoadCCTV" class="px-3 py-1 rounded bg-slate-700 hover:bg-slate-600 text-sm">Muat CCTV</button>
        <button id="btnLoadPOI" class="px-3 py-1 rounded bg-slate-700 hover:bg-slate-600 text-sm">Muat POI/Heatmap</button>
      </div>
    </section>

    <section class="card p-3 space-y-3">
      <h2 class="font-semibold">Kalkulator Kepadatan (BPR)</h2>
      <div class="grid grid-cols-2 gap-2 text-sm">
        <label class="space-y-1"><span>T aktual (menit)</span><input id="T_actual" type="number" class="w-full rounded bg-slate-800 p-2" value="25" /></label>
        <label class="space-y-1"><span>T free flow (menit)</span><input id="T_freeflow" type="number" class="w-full rounded bg-slate-800 p-2" value="15" /></label>
        <label class="space-y-1"><span>Jarak L (km)</span><input id="L_distance" type="number" class="w-full rounded bg-slate-800 p-2" value="8" /></label>
        <label class="space-y-1"><span>Kapasitas qpc (veh/h)</span><input id="q_capacity" type="number" class="w-full rounded bg-slate-800 p-2" value="2000" /></label>
        <label class="space-y-1"><span>α (alpha)</span><input id="alpha_param" type="number" step="0.01" class="w-full rounded bg-slate-800 p-2" value="0.15" /></label>
        <label class="space-y-1"><span>β (beta)</span><input id="beta_param" type="number" class="w-full rounded bg-slate-800 p-2" value="4" /></label>
      </div>
      <div class="flex gap-2">
        <button id="btnCalc" class="px-3 py-1 rounded bg-emerald-600 hover:bg-emerald-500 text-sm">Hitung</button>
        <button id="btnDirections" class="px-3 py-1 rounded bg-slate-700 hover:bg-slate-600 text-sm">Isi dari Directions (LIVE)</button>
      </div>
      <div class="text-sm">
        <div>q (veh/h): <span id="result_q" class="font-mono">-</span></div>
        <div>N (veh on link): <span id="result_N" class="font-mono">-</span></div>
      </div>

      <h2 class="font-semibold mt-4">Insights</h2>
      <ul id="insightList" class="text-sm space-y-2"></ul>
    </section>
  </main>

  <!-- Modal video -->
  <div id="videoModal" class="modal">
    <div class="card p-3 w-full max-w-3xl">
      <div class="flex items-center justify-between">
        <h3 class="font-semibold">Live Stream</h3>
        <button id="closeModal" class="px-2 py-1 text-sm bg-slate-700 rounded">Tutup</button>
      </div>
      <div class="mt-2">
        <video id="videoEl" controls playsinline class="w-full rounded"></video>
        <iframe id="webrtcEl" class="w-full h-96 rounded hidden"></iframe>
      </div>
      <form id="uploadForm" class="mt-3 flex items-center gap-2 text-xs">
        <input type="file" id="videoFile" accept="video/*" class="text-xs"/>
        <button type="submit" class="bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded">Upload report</button>
        <span id="uploadHint" class="opacity-70"></span>
      </form>
    </div>
  </div>

  <script>
    const API_BASE = "http://localhost:8091";

    // Map
    const map = L.map('map').setView([-6.2, 106.82], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM' }).addTo(map);

    const cctvLayer = L.layerGroup().addTo(map);
    const heatmapLayer = L.layerGroup().addTo(map);

    const cctvIcon = L.icon({
      iconUrl: 'https://cdn-icons-png.flaticon.com/512/483/483947.png',
      iconSize: [28, 28]
    });

    async function loadCCTV() {
      const res = await fetch(`${API_BASE}/api/cctv`);
      const list = await res.json();
      cctvLayer.clearLayers();
      list.forEach(item => {
        L.marker([item.lat, item.lng], { icon: cctvIcon })
          .on('click', () => openModal(item))
          .addTo(cctvLayer)
          .bindPopup(`<b>${item.name}</b>`);
      });
    }
    document.getElementById('btnLoadCCTV').addEventListener('click', loadCCTV);

    async function loadPOI() {
      const res = await fetch(`${API_BASE}/api/poi`);
      const list = await res.json();
      heatmapLayer.clearLayers();
      list.forEach(poi => {
        const color = poi.crowd_index > 0.75 ? '#ef4444' : (poi.crowd_index > 0.5 ? '#f59e0b' : '#22c55e');
        L.circle([poi.lat, poi.lng], { radius: poi.radius, color, fillColor: color, fillOpacity: 0.3, weight: 1 })
          .addTo(heatmapLayer)
          .bindPopup(`<b>${poi.name}</b><br/>crowd: ${poi.crowd_index}`);
      });
    }
    document.getElementById('btnLoadPOI').addEventListener('click', loadPOI);

    async function fetchInsights() { try { const r = await fetch(`${API_BASE}/api/insights`); return await r.json(); } catch { return []; } }
    async function updateInsights() {
      const items = await fetchInsights();
      const ul = document.getElementById('insightList');
      ul.innerHTML = '';
      items.forEach(x => {
        const li = document.createElement('li');
        const tag = x.type.toUpperCase();
        li.innerHTML = `<span class="px-1.5 py-0.5 rounded text-xs mr-2 ${x.type==='alert'?'bg-red-600':x.type==='warning'?'bg-amber-600':'bg-slate-700'}">${tag}</span>${x.message} <span class="opacity-60">· ${x.time}</span>`;
        ul.appendChild(li);
      });
    }
    updateInsights(); setInterval(updateInsights, 60000);

    // Modal
    const modal = document.getElementById('videoModal');
    const videoEl = document.getElementById('videoEl');
    const webrtcEl = document.getElementById('webrtcEl');
    document.getElementById('closeModal').onclick = () => { modal.style.display = 'none'; stopPlayers(); };

    function stopPlayers(){
      if (videoEl.src) { videoEl.pause(); videoEl.removeAttribute('src'); videoEl.load(); }
      webrtcEl.src = ''; webrtcEl.classList.add('hidden');
    }
    function openModal(item){
      modal.style.display = 'flex';
      stopPlayers();
      const url = item.url || '';
      if (url.includes('.m3u8')) {
        const src = `${API_BASE}/api/proxy?url=${encodeURIComponent(url)}`;
        if (Hls.isSupported()) {
          const hls = new Hls();
          hls.loadSource(src);
          hls.attachMedia(videoEl);
          videoEl.play();
        } else {
          videoEl.src = src; videoEl.play();
        }
        webrtcEl.classList.add('hidden'); videoEl.classList.remove('hidden');
      } else {
        webrtcEl.src = url; webrtcEl.classList.remove('hidden'); videoEl.classList.add('hidden');
      }
    }

    // Upload video
    document.getElementById('uploadForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const f = document.getElementById('videoFile').files[0];
      if (!f) return alert('Pilih video dulu');
      const fd = new FormData();
      fd.append('file', f);
      fd.append('region', 'JABAR');
      fd.append('poi_id', 'poi-kuta');
      const r = await fetch(`${API_BASE}/api/video-report`, { method: 'POST', body: fd });
      const j = await r.json();
      document.getElementById('uploadHint').textContent = j.ok ? `Uploaded: ${location.origin}${j.url}` : (j.error||'Upload gagal');
    });

    // BPR -> backend
    document.getElementById('btnCalc').addEventListener('click', async () => {
      const body = {
        T_min: Number(document.getElementById('T_actual').value),
        Tff_min: Number(document.getElementById('T_freeflow').value),
        L_km: Number(document.getElementById('L_distance').value),
        qpc: Number(document.getElementById('q_capacity').value),
        alpha: Number(document.getElementById('alpha_param').value),
        beta: Number(document.getElementById('beta_param').value)
      };
      const r = await fetch(`${API_BASE}/api/traffic/estimate`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
      const j = await r.json();
      if (j.error) return alert(j.error);
      document.getElementById('result_q').textContent = j.q_veh_per_h.toFixed(2);
      document.getElementById('result_N').textContent = String(j.N_veh);
    });

    // LIVE Directions (optional)
    document.getElementById('btnDirections').addEventListener('click', async () => {
      const origin = '-6.9175,107.6191'; // Bandung alun-alun
      const dest   = '-6.1944,106.8229'; // Bundaran HI
      const q = new URLSearchParams({ origin, destination: dest });
      const r = await fetch(`${API_BASE}/api/directions?${q}`);
      const j = await r.json();
      if (j.error) return alert(j.error);
      document.getElementById('T_actual').value = j.T_min;
      document.getElementById('L_distance').value = j.L_km;
      alert('Durasi & jarak terisi dari Directions');
    });
  </script>
</body>
</html>
